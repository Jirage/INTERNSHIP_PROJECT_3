pipeline {
    agent any

    environment {
        DB_NAME = "studentsdb"
        DB_USER = "root"
        DB_PASS = "root"
    }

    stages {

        stage('Install MariaDB') {
            steps {
                sh '''
                sudo dnf install -y mariadb105-server mariadb105
                '''
            }
        }

        stage('Start MariaDB') {
            steps {
                sh '''
                sudo systemctl start mariadb
                '''
            }
        }

        stage('Enable MariaDB') {
            steps {
                sh '''
                sudo systemctl enable mariadb
                '''
            }
        }

        stage('Create Database & Table') {
            steps {
                sh '''
                mysql -u${DB_USER} -p${DB_PASS} <<EOF
                CREATE DATABASE IF NOT EXISTS studentsdb;
                USE studentsdb;

                CREATE TABLE IF NOT EXISTS students (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(100),
                    email VARCHAR(100),
                    phone VARCHAR(20),
                    course VARCHAR(100),
                    address TEXT,
                    contact VARCHAR(20)
                );
                EOF
                '''
            }
        }

        stage('Clone Repository') {
            steps {
                git 'https://github.com/YOUR_GITHUB_USERNAME/stud-reg-flask-app.git'
            }
        }

        stage('Install Python Dependencies') {
            steps {
                sh '''
                python3 -m venv venv
                source venv/bin/activate
                pip install --upgrade pip
                pip install flask mysql-connector-python
                '''
            }
        }

        stage('Run Flask App') {
            steps {
                sh '''
                source venv/bin/activate
                nohup python3 app.py &
                '''
            }
        }
    }
}
