pipeline {
    agent any

    environment {
        APP_SERVER = "localhost"
        DB_NAME = "studentsdb"
        DB_USER = "root"
        DB_PASS = "root"
    }

    stages {

        stage('SSH Test') {
            steps {
                sh '''
                ssh -o StrictHostKeyChecking=no ${APP_SERVER} "echo SSH connection successful"
                '''
            }
        }

        stage('Install MariaDB on App Server') {
            steps {
                sh '''
                ssh ${APP_SERVER} "
                sudo dnf install -y mariadb105-server mariadb105
                "
                '''
            }
        }

        stage('Start & Enable MariaDB') {
            steps {
                sh '''
                ssh ${APP_SERVER} "
                sudo systemctl start mariadb
                sudo systemctl enable mariadb
                "
                '''
            }
        }

        stage('Create Database & Table') {
            steps {
                sh '''
                ssh ${APP_SERVER} "
                mysql -u${DB_USER} -p${DB_PASS} <<EOF
                CREATE DATABASE IF NOT EXISTS studentsdb;
                USE studentsdb;
                CREATE TABLE IF NOT EXISTS students (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(100),
                    email VARCHAR(100),
                    phone VARCHAR(20),
                    course VARCHAR(100),
                    address TEXT,
                    contact VARCHAR(20)
                );
                EOF
                "
                '''
            }
        }

        stage('Deploy Flask Application') {
            steps {
                sh '''
                ssh ${APP_SERVER} "
                sudo dnf install -y python3 python3-pip
                git clone https://github.com/YOUR_GITHUB_USERNAME/stud-reg-flask-app.git || true
                cd stud-reg-flask-app
                python3 -m venv venv
                source venv/bin/activate
                pip install --upgrade pip
                pip install flask mysql-connector-python
                nohup python3 app.py &
                "
                '''
            }
        }
    }
}
