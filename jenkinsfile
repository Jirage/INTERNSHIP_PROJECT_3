pipeline {
    agent any

    environment {
        DB_NAME = "studentsdb"
    }

    stages {

        stage('Install MariaDB') {
            steps {
                sh '''
                sudo dnf install -y mariadb105-server mariadb105 || true
                '''
            }
        }

        stage('Start & Enable MariaDB') {
            steps {
                sh '''
                sudo systemctl start mariadb || true
                sudo systemctl enable mariadb || true
                '''
            }
        }

        stage('Create Database & Table') {
            steps {
                sh '''
                sudo mysql <<EOF
                CREATE DATABASE IF NOT EXISTS studentsdb;
                USE studentsdb;
                CREATE TABLE IF NOT EXISTS students (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(100),
                    email VARCHAR(100),
                    phone VARCHAR(20),
                    course VARCHAR(100),
                    address TEXT
                );
                EOF
                '''
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Jirage/INTERNSHIP_PROJECT_3.git'
            }
        }

        stage('Install Python Dependencies') {
            steps {
                sh '''
                python3 -m venv venv || true
                source venv/bin/activate
                pip install --upgrade pip
                pip install -r requirements.txt || pip install flask mysql-connector-python
                '''
            }
        }

        stage('Stop Existing Flask App') {
            steps {
                sh '''
                sudo fuser -k 5000/tcp || true
                '''
            }
        }

        stage('Run Flask App') {
            steps {
                sh '''
                source venv/bin/activate

                # Start Flask in background with logs
                nohup python3 app.py > flask.log 2>&1 &

                sleep 5
                '''
            }
        }

        stage('Verify App') {
            steps {
                sh '''
                sudo ss -tulnp | grep 5000 || true
                curl -I http://localhost:5000 || true
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Deployment successful! Flask app is running on port 5000"
        }
        failure {
            echo "❌ Deployment failed. Check flask.log for details."
        }
    }
}
