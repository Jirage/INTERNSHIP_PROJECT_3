pipeline {
    agent any

    stages {

        stage('Install MariaDB') {
            steps {
                sh '''
                sudo dnf install -y mariadb105-server mariadb105 || true
                '''
            }
        }

        stage('Start & Enable MariaDB') {
            steps {
                sh '''
                sudo systemctl start mariadb
                sudo systemctl enable mariadb
                '''
            }
        }

        stage('Create Database & Table') {
            steps {
                sh '''
                echo "CREATE DATABASE IF NOT EXISTS studentsdb;
                USE studentsdb;
                CREATE TABLE IF NOT EXISTS students (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(100),
                    email VARCHAR(100),
                    phone VARCHAR(20),
                    course VARCHAR(100),
                    address TEXT
                );" | sudo mysql
                '''
            }
        }

        stage('Clone Repository') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Jirage/INTERNSHIP_PROJECT_3.git'
            }
        }

        stage('Install Python Dependencies') {
            steps {
                sh '''
                python3 -m venv venv || true
                source venv/bin/activate
                pip install --upgrade pip
                pip install flask mysql-connector-python
                '''
            }
        }

        stage('Run Flask App') {
            steps {
                sh '''
                source venv/bin/activate
                python3 app.py
                '''
            }
        }
    }
}
